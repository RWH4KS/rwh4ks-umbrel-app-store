version: '3.8'
services:
  web:
    image: nginx:alpine
    restart: on-failure
    stop_grace_period: 10s
    networks:
      - internal
      - umbrel_main_network
    ports:
      - "8080:8080"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./dashboard/app_proxy.conf:/etc/nginx/conf.d/default.conf:ro
  bchn_rpc_proxy:
    image: nginx:alpine
    restart: on-failure
    stop_grace_period: 10s
    depends_on:
      bchn:
        condition: service_healthy
    networks:
      - internal
    expose:
      - "8332"
    environment:
      APP_BCHN_RPC_USER: ${APP_BCHN_RPC_USER}
      APP_BCHN_RPC_PASSWORD: ${APP_BCHN_RPC_PASSWORD}
    volumes:
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
    command: >
      /bin/sh -lc '
        export BCH_RPC_BASIC="$(printf "%s:%s" "$APP_BCHN_RPC_USER" "$APP_BCHN_RPC_PASSWORD" | base64 | tr -d "\n")";
        export BCH_RPC_BASIC;
        exec /docker-entrypoint.sh nginx -g "daemon off;";
      '

  bchn:
    image: ghcr.io/rwh4ks/bchn-arm64:0.1.0
    platform: linux/arm64
    restart: on-failure
    stop_grace_period: 60s
    healthcheck:
      test: 
        [
          "CMD-SHELL",
          "wget -qO- --timeout=2 --user=$${APP_BCHN_RPC_USER} --password=$${APP_BCHN_RPC_PASSWORD} --header='Content-Type: application/json' --post-data='{\"jsonrpc\":\"1.0\",\"id\":\"hc\",\"method\":\"getblockchaininfo\",\"params\":[]}' http://127.0.0.1:8332/ >/dev/null 2>&1 || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 60
      start_period: 60s
    environment:
      APP_BCHN_RPC_USER: ${APP_BCHN_RPC_USER}
      APP_BCHN_RPC_PASSWORD: ${APP_BCHN_RPC_PASSWORD}
    command:
      - /opt/bin/bitcoind
      - -printtoconsole
      - -server=1
      - -prune=${APP_BCHN_PRUNE_MIB}
      - -rpcbind=0.0.0.0
      - -rpcallowip=10.0.0.0/8
      - -rpcallowip=172.16.0.0/12
      - -rpcallowip=192.168.0.0/16
      - -rpcuser=${APP_BCHN_RPC_USER}
      - -rpcpassword=${APP_BCHN_RPC_PASSWORD}
    volumes:
      - ${APP_DATA_DIR}/data/bchn:/root/.bitcoin
    networks:
      internal:
        aliases:
          - bchn-1
      umbrel_main_network:
  mariadb:
    image: mariadb:11
    restart: on-failure
    stop_grace_period: 60s
    environment:
      MYSQL_DATABASE: ${APP_MARIADB_DATABASE}
      MYSQL_USER: ${APP_MARIADB_USER}
      MYSQL_PASSWORD: ${APP_MARIADB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${APP_MARIADB_ROOT_PASSWORD}
    volumes:
      - ${APP_DATA_DIR}/data/mariadb:/var/lib/mysql
    networks:
      - internal
  memcached:
    image: memcached:1.6
    restart: on-failure
    stop_grace_period: 60s
    command:
      - '-m'
      - '256'
      - '-o'
      - modern
    networks:
      - internal
  yiimp:
    image: ghcr.io/rwh4ks/yiimp-arm64:0.1.0
    restart: on-failure
    stop_grace_period: 60s
    depends_on:
      - mariadb
      - memcached
    environment:
      DB_HOST: mariadb
      DB_NAME: ${APP_MARIADB_DATABASE}
      DB_USER: ${APP_MARIADB_USER}
      DB_PASS: ${APP_MARIADB_PASSWORD}
      MEMCACHED_HOST: memcached
    networks:
      - internal
  public-pool:
    image: ghcr.io/rwh4ks/public-pool-arm64:0.1.0
    restart: on-failure
    stop_grace_period: 60s
    depends_on:
      bchn:
        condition: service_healthy
      yiimp:
        condition: service_started
      mariadb:
        condition: service_started
      memcached:
        condition: service_started
    environment:
      BCH_RPC_URL: http://bchn_rpc_proxy:8332
      BITCOIN_RPC_URL: http://bchn_rpc_proxy
      BITCOIN_RPC_PORT: "8332"
      BITCOIN_RPC_TIMEOUT: "5000"
      BITCOIN_RPC_USER: ${APP_BCHN_RPC_USER}
      BITCOIN_RPC_PASSWORD: ${APP_BCHN_RPC_PASSWORD}
      BCH_RPC_USER: ${APP_BCHN_RPC_USER}
      BCH_RPC_PASS: ${APP_BCHN_RPC_PASSWORD}
      STRATUM_PORT: 3563
      API_PORT: 3564
      DB_HOST: mariadb
      DB_NAME: ${APP_MARIADB_DATABASE}
      DB_USER: ${APP_MARIADB_USER}
      DB_PASS: ${APP_MARIADB_PASSWORD}
      MEMCACHED_HOST: memcached
    ports:
      - "3563:3563"
      - "3564:3564"
    networks:
      - internal
      - umbrel_main_network
  dashboard:
    image: nginx:alpine
    restart: on-failure
    stop_grace_period: 10s
    networks:
      - internal
      - umbrel_main_network
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./dashboard/default.conf:/etc/nginx/conf.d/default.conf:ro
networks:
  internal:
    driver: bridge
    internal: true
  umbrel_main_network:
    external: true
