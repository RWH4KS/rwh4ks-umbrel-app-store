<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Public Pool UI</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .row { display: flex; flex-wrap: wrap; gap: 12px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px 14px; min-width: 240px; flex: 1; }
      .k { color: #666; font-size: 12px; margin-bottom: 6px; }
      .v { font-size: 22px; font-weight: 700; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
      pre { background: #0b0b0b; color: #eaeaea; padding: 12px; border-radius: 12px; overflow: auto; }
      .ok { color: #0a7a2f; font-weight: 700; }
      .bad { color: #b00020; font-weight: 700; }
      table { border-collapse: collapse; width: 100%; margin-top: 10px; }
      th, td { border-bottom: 1px solid #eee; text-align: left; padding: 8px; font-size: 14px; }
      th { color: #666; font-weight: 600; }
      .small { color: #666; font-size: 13px; }
    </style>
  </head>

  <body>
    <h1>Public Pool UI</h1>

    <div class="small">
      Status: <span id="status" class="bad">Loading…</span>
      &nbsp;|&nbsp; Stratum: <code id="stratum"></code>
      &nbsp;|&nbsp; API (proxied): <code id="apiBase"></code>
    </div>

    <h2 style="margin-top:16px;">Summary</h2>
    <div class="row">
      <div class="card"><div class="k">Workers</div><div class="v" id="workers">—</div></div>
      <div class="card"><div class="k">Total Hashrate</div><div class="v" id="hashrate">—</div></div>
      <div class="card"><div class="k">Best Difficulty</div><div class="v" id="bestDiff">—</div></div>
      <div class="card"><div class="k">Block Height</div><div class="v" id="height">—</div></div>
      <div class="card"><div class="k">Network Difficulty</div><div class="v" id="netDiff">—</div></div>
      <div class="card"><div class="k">Network Hashrate</div><div class="v" id="netHash">—</div></div>
    </div>

    <h2 style="margin-top:16px;">User Agents</h2>
    <table>
      <thead>
        <tr>
          <th>User Agent</th>
          <th>Workers</th>
          <th>Hashrate</th>
          <th>Best Difficulty</th>
        </tr>
      </thead>
      <tbody id="uaRows">
        <tr><td colspan="4" class="small">Loading…</td></tr>
      </tbody>
    </table>

    <h2 style="margin-top:16px;">Raw</h2>
    <div class="row">
      <div class="card" style="min-width: 360px; flex: 2;">
        <div class="k">/api/info</div>
        <pre id="rawInfo">{}</pre>
      </div>
      <div class="card" style="min-width: 360px; flex: 2;">
        <div class="k">/api/network</div>
        <pre id="rawNet">{}</pre>
      </div>
    </div>

    <script>
      // Config:
      const API_BASE = (window.PUBLIC_POOL_UPSTREAM_API || "/api").replace(/\/$/, "");
      const STRATUM = window.PUBLIC_POOL_STRATUM || ("stratum+tcp://" + window.location.hostname + ":3563");

      document.getElementById("apiBase").textContent = window.location.origin + "/api";
      document.getElementById("stratum").textContent = STRATUM;

      function fmtHashrate(h) {
        if (!Number.isFinite(h)) return "—";
        const units = ["H/s","KH/s","MH/s","GH/s","TH/s","PH/s","EH/s"];
        let i = 0;
        while (h >= 1000 && i < units.length - 1) { h /= 1000; i++; }
        return (h >= 100 ? h.toFixed(0) : h >= 10 ? h.toFixed(1) : h.toFixed(2)) + " " + units[i];
      }

      function fmtInt(n) {
        if (!Number.isFinite(n)) return "—";
        return Math.round(n).toLocaleString();
      }

      async function loadOnce() {
        const statusEl = document.getElementById("status");
        try {
          const [infoRes, netRes] = await Promise.all([
            fetch(API_BASE + "/info", { cache: "no-store" }),
            fetch(API_BASE + "/network", { cache: "no-store" }),
          ]);

          if (!infoRes.ok || !netRes.ok) throw new Error("HTTP " + infoRes.status + "/" + netRes.status);

          const info = await infoRes.json();
          const net = await netRes.json();

          statusEl.textContent = "OK";
          statusEl.className = "ok";

          // Summary /api/info:
          const uas = Array.isArray(info.userAgents) ? info.userAgents : [];
          const totalWorkers = uas.reduce((a, x) => a + (Number(x.count) || 0), 0);
          const totalHash = uas.reduce((a, x) => a + (Number(x.totalHashRate) || 0), 0);
          const bestDiff = uas.reduce((m, x) => Math.max(m, Number(x.bestDifficulty) || 0), 0);

          document.getElementById("workers").textContent = fmtInt(totalWorkers);
          document.getElementById("hashrate").textContent = fmtHashrate(totalHash);
          document.getElementById("bestDiff").textContent = bestDiff ? bestDiff.toLocaleString(undefined, { maximumFractionDigits: 3 }) : "—";

          // Network:
          document.getElementById("height").textContent = fmtInt(Number(net.blocks));
          document.getElementById("netDiff").textContent = Number(net.difficulty).toLocaleString(undefined, { maximumFractionDigits: 3 });
          document.getElementById("netHash").textContent = fmtHashrate(Number(net.networkhashps));

          // UA table:
          const tbody = document.getElementById("uaRows");
          tbody.innerHTML = "";
          if (!uas.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="small">No user agent data yet.</td></tr>`;
          } else {
            for (const x of uas) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${(x.userAgent || "unknown")}</td>
                <td>${fmtInt(Number(x.count))}</td>
                <td>${fmtHashrate(Number(x.totalHashRate))}</td>
                <td>${(Number(x.bestDifficulty) || 0).toLocaleString(undefined, { maximumFractionDigits: 3 })}</td>
              `;
              tbody.appendChild(tr);
            }
          }

          // Raw:
          document.getElementById("rawInfo").textContent = JSON.stringify(info, null, 2);
          document.getElementById("rawNet").textContent = JSON.stringify(net, null, 2);

        } catch (e) {
          statusEl.textContent = "ERROR";
          statusEl.className = "bad";
          document.getElementById("rawInfo").textContent = String(e);
          document.getElementById("rawNet").textContent = String(e);
        }
      }

      loadOnce();
      setInterval(loadOnce, 5000);
    </script>
  </body>
</html>
